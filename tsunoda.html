<html>
  <head>
    <meta charset="utf-8">
    <title>Tsunoda Student System</title>
    <link rel="icon" type="image/png" href="/tsunoda/tsunoda.png">

    <link rel="stylesheet" href="/tsunoda/main.css">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>


    <!-- set to ios desktop -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-title" content="Tsunoda PWA">
    <link rel="apple-touch-icon" href="/tsunoda/tsunoda.png">

    <link rel="manifest" href="/tsunoda/manifast.json">



    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id"
        content="688649811741-qsf4neneila70g04mlroms3q340vij3i.apps.googleusercontent.com">
  </head>
  <body>


    <div id="app">

      <div class="g-signin2 col-xs-10 float:left" data-onsuccess="onSignIn"></div>

      <audio id="bgMusic" type="audio/mpeg" src="https://tsunodanihongo.github.io/tsunoda/signin.mp3"></audio>
      <p><input id="playAudioKey" type="button" value="効果音を放送する" style="width:200px;height:50px;font-size:16pt;" onclick="playAudio()" /></p>


      <div id="container">
        <h1> <a>角田日語 刷卡系統</a> </h1>
      </div>


      <div class="preview-container">
        <video id="preview"></video>
      </div>

      <div class="student_info"  id="show_alert" data-toggle="tooltip" data-placement="top">
        <ul1><h2> 學號 </h2><li id="student_id"></li></ul1><ul2><h2> 姓名 </h2><li id="student_name"></li></ul2><ul2><h2> 日文名 </h2><li id="student_japan_name"></li></ul2><ul3><h2> 狀態 </h2><li id="student_status"></li></ul3>
      </div>

    </div>
    <script type="text/javascript">
      let scanner = new Instascan.Scanner({
          video: document.getElementById('preview')
      });
      // 開啟一個新的掃描
      // 宣告變數scanner，在html<video>標籤id為preview的地方開啟相機預覽。
      // Notice:這邊注意一定要用<video>的標籤才能使用，詳情請看他的github API的部分解釋。

      scanner.addListener('scan', function(content) {
          console.log(content);
          var student_qr = content.split(";");
          pauseVid();
          getInfo(student_qr);
      });
      function playVid()
      { document.getElementById('preview').play(); }
      function pauseVid()
      {document.getElementById('preview').pause();}
      //開始偵聽掃描事件，若有偵聽到印出內容。



      Instascan.Camera.getCameras().then(function(cameras) {
      //取得設備的相機數目
          if (cameras.length > 0) {
            ///若設備相機數目大於0 則先開啟第0個相機(程式的世界是從第零個開始的)
              scanner.start(cameras[0]);
          } else {
            //若設備沒有相機數量則顯示"No cameras found";
            //這裡自行判斷要寫什麼
              console.error('No cameras found.');
          }
      }).catch(function(e) {
          console.error(e);
      });



      function getInfo(student_qr){
          var dt = new Date();
          var year = dt.getFullYear();
          var month = dt.getMonth()+1;
          var day = dt.getDate();

          jQuery.get("https://script.google.com/macros/s/AKfycbxc51dfGOeLJfBD_mq_g48gaBjwlOKE9OA2fCRLsqNwB4_nHl0/exec", {
                  "checkEmail": emailStr,
                  "index": student_qr[2],
                  "sheetId": student_qr[1],
                  "year": year,
                  "month": month,
                  "day": day,
                  "date": dt.yyyymmdd(),
                  "time": dt.HHMMss()
          },function (data) {
              playVid();
              console.log(data);
              //有錯誤
              if(!data.includes(",")){

                if(data.includes("hadswiped")){
                  showPopover("已刷卡");
                  playSound("/tsunoda/pika.mp3");
                }else{
                  showPopover(data);
                }

              }else{

                var info_split = data.split(",");
                document.getElementById("student_id").innerHTML = info_split[1];
                document.getElementById("student_name").innerHTML = info_split[2];
                document.getElementById("student_japan_name").innerHTML = info_split[3];
                 document.getElementById("student_status").innerHTML = info_split[5];

                if(student_qr[2] == "14"){
                  playSound("https://tsunodanihongo.github.io/tsunoda/pika.mp3");
                }else{
                  playSound("https://tsunodanihongo.github.io/tsunoda/signin.mp3");
                }

                if(info_split[5] == "到期線上待繳"){
                  document.getElementById("student_status").style.backgroundColor ='#FF0000';

                }else if(info_split[5] == "延課中"){
                 document.getElementById("student_status").style.backgroundColor ='#FFFF00';

                }else{
                  document.getElementById("student_status").style.backgroundColor ='#FFF8DB';
                }


              }
          });
      }

      Date.prototype.yyyymmdd = function() {
        var mm = this.getMonth() + 1; // getMonth() is zero-based
        var dd = this.getDate();

        return [this.getFullYear(),
                (mm>9 ? '' : '0') + mm,
                (dd>9 ? '' : '0') + dd
              ].join('-');
      };

      Date.prototype.HHMMss = function() {
        var HH = this.getHours();
        var MM = this.getMinutes();
        var ss = this.getSeconds();

        return [(HH>9 ? '' : '0') + HH,
                (MM>9 ? '' : '0') + MM,
                (ss>9 ? '' : '0') + ss
              ].join('');
      };

      var audio    = document.getElementById('bgMusic');
      var audioKey = document.getElementById('playAudioKey');
      function playAudio() {
        audioKey.style.visibility = 'hidden';
        audio.setAttribute('src', "https://tsunodanihongo.github.io/tsunoda/signin.mp3");
        audio.play();
      }
      function playSound(src) {
        audio.setAttribute('src', src);
        audio.play();
      }
      function showPopover(meg) {
        alert(meg);
      }

      function showPopover1(meg) {
        $("#show_alert").attr("data-original-title", meg);
        $('[data-toggle="tooltip"]').tooltip();
        $("#show_alert").tooltip('show');
        $("#show_alert").focus();

        //2秒后消失提示框
        var id = setTimeout(
            function () {
                $("#show_alert").attr("data-original-title", "");
                $("#show_alert").tooltip('hide');
            }, 2000
        );
      }

      var emailStr;
      function onSignIn(googleUser) {
          var profile = googleUser.getBasicProfile();
          console.log('Name: ' + profile.getName());
          console.log('ID: ' +  profile.getId());
          console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
          emailStr = profile.getName() + "," + profile.getEmail();
      }

      function signOut() {
          var auth2 = gapi.auth2.getAuthInstance();
          auth2.signOut().then(function () {
              BootstrapDialog.alert('User signed out.');
              console.log('User signed out.');
          });
      }


    </script>

    <script>

        // CODELAB: Register service worker.
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/tsunoda/service-worker.js')
              .then((reg) => {
                console.log('Service worker registered.', reg);
              });
        });
      }
    </script>


  </body>
</html>
